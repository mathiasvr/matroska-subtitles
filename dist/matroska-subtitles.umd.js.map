{"version":3,"file":"matroska-subtitles.umd.js","sources":["../src/subtitle-parser-base.js","../src/subtitle-parser.js","../src/subtitle-stream.js"],"sourcesContent":["import { Transform } from 'readable-stream'\nimport { EbmlStreamDecoder, EbmlTagId } from 'ebml-stream'\nimport { inflateSync } from 'zlib'\n\nconst SSA_TYPES = new Set(['ssa', 'ass'])\nconst SSA_KEYS = ['readOrder', 'layer', 'style', 'name', 'marginL', 'marginR', 'marginV', 'effect', 'text']\n\nfunction getData (chunk, id) {\n  const el = chunk.Children.find(c => c.id === id)\n  return el ? el.data : undefined\n}\n\nexport class SubtitleParserBase extends Transform {\n  constructor () {\n    super()\n\n    this.subtitleTracks = new Map()\n    this.timecodeScale = 1\n\n    this._currentClusterTimecode = null\n\n    this.decoder = new EbmlStreamDecoder({\n      bufferTagIds: [\n        EbmlTagId.TimecodeScale,\n        EbmlTagId.Tracks,\n        EbmlTagId.BlockGroup,\n        EbmlTagId.AttachedFile\n      ]\n    })\n\n    this.decoder.on('data', this.parseEbmlSubtitles.bind(this))\n  }\n\n  parseEbmlSubtitles (chunk) {\n    // Segment Information\n    if (chunk.id === EbmlTagId.TimecodeScale) {\n      this.timecodeScale = chunk.data / 1000000\n    }\n\n    // Assumption: This is a Cluster `Timecode`\n    if (chunk.id === EbmlTagId.Timecode) {\n      this._currentClusterTimecode = chunk.data\n    }\n\n    if (chunk.id === EbmlTagId.Tracks) {\n      for (const entry of chunk.Children.filter(c => c.id === EbmlTagId.TrackEntry)) {\n        // Skip non subtitle tracks\n        if (getData(entry, EbmlTagId.TrackType) !== 0x11) continue\n\n        const codecID = getData(entry, EbmlTagId.CodecID) || ''\n        if (codecID.startsWith('S_TEXT')) {\n          const track = {\n            number: getData(entry, EbmlTagId.TrackNumber),\n            language: getData(entry, EbmlTagId.Language),\n            type: codecID.substring(7).toLowerCase()\n          }\n\n          const name = getData(entry, EbmlTagId.Name)\n          if (name) {\n            track.name = name\n          }\n\n          const header = getData(entry, EbmlTagId.CodecPrivate)\n          if (header && SSA_TYPES.has(track.type)) {\n            track.header = header.toString()\n          }\n\n          // TODO: Assume zlib deflate compression\n          const compressed = entry.Children.find(c =>\n            c.id === EbmlTagId.ContentEncodings &&\n            c.Children.find(cc =>\n              cc.id === EbmlTagId.ContentEncoding &&\n              cc.Children.find(ccc => ccc.id === EbmlTagId.ContentCompression)))\n\n          if (compressed) {\n            track._compressed = true\n          }\n\n          this.subtitleTracks.set(track.number, track)\n        }\n      }\n\n      this.emit('tracks', Array.from(this.subtitleTracks.values()))\n    }\n\n    if (chunk.id === EbmlTagId.BlockGroup) {\n      const block = chunk.Children.find(c => c.id === EbmlTagId.Block)\n\n      if (block && this.subtitleTracks.has(block.track)) {\n        const blockDuration = getData(chunk, EbmlTagId.BlockDuration)\n        const track = this.subtitleTracks.get(block.track)\n\n        const payload = track._compressed ? inflateSync(Buffer.from(block.payload)) : block.payload\n\n        const subtitle = {\n          text: payload.toString('utf8'),\n          time: (block.value + this._currentClusterTimecode) * this.timecodeScale,\n          duration: blockDuration * this.timecodeScale\n        }\n\n        if (SSA_TYPES.has(track.type)) {\n          // extract SSA/ASS keys\n          const values = subtitle.text.split(',')\n\n          // ignore read-order, and skip layer if ssa\n          for (let i = track.type === 'ssa' ? 2 : 1; i < 8; i++) {\n            subtitle[SSA_KEYS[i]] = values[i]\n          }\n\n          subtitle.text = values.slice(8).join(',')\n        }\n\n        this.emit('subtitle', subtitle, block.track)\n      }\n    }\n\n    // Parse attached files, mainly to allow extracting subtitle font files.\n    if (chunk.id === EbmlTagId.AttachedFile) {\n      this.emit('file', {\n        filename: getData(chunk, EbmlTagId.FileName),\n        mimetype: getData(chunk, EbmlTagId.FileMimeType),\n        data: getData(chunk, EbmlTagId.FileData)\n      })\n    }\n  }\n}\n","import { EbmlTagId } from 'ebml-stream'\nimport { SubtitleParserBase } from './subtitle-parser-base'\n\nexport class SubtitleParser extends SubtitleParserBase {\n  constructor () {\n    super()\n\n    this.decoder.on('data', (chunk) => {\n      if (chunk.id === EbmlTagId.Tracks) {\n        // stop decoding if no subtitle tracks are present\n        if (this.subtitleTracks.size === 0) this.end()\n      }\n    })\n  }\n\n  _write (chunk, _, callback) {\n    this.decoder.write(chunk)\n    callback(null, chunk)\n  }\n}\n","import { SubtitleParserBase } from './subtitle-parser-base'\n\nexport class SubtitleStream extends SubtitleParserBase {\n  constructor (prevInstance) {\n    super()\n\n    if (prevInstance instanceof SubtitleStream) {\n      prevInstance.once('drain', () => prevInstance.end())\n\n      // copy previous metadata\n      this.subtitleTracks = prevInstance.subtitleTracks\n      this.timecodeScale = prevInstance.timecodeScale\n\n      // may not be at ebml tag offset\n      this.unstable = true\n    }\n  }\n\n  // passthrough stream: data is intercepted but not transformed\n  _transform (chunk, _, callback) {\n    if (this.unstable) {\n      // the ebml decoder expects to see a tag, so we won't use it until we find a cluster\n      for (let i = 0; i < chunk.length - 12; i++) {\n        // cluster id\n        if (chunk[i] === 0x1f && chunk[i + 1] === 0x43 && chunk[i + 2] === 0xb6 && chunk[i + 3] === 0x75) {\n          // length of cluster size tag\n          const len = 8 - Math.floor(Math.log2(chunk[i + 4]))\n          // first tag in cluster is cluster timecode\n          if (chunk[i + 4 + len] === 0xe7) {\n            // okay this is probably a cluster\n            this.unstable = false\n            this.decoderWrite(chunk.slice(i))\n            break\n          }\n        }\n      }\n    } else {\n      this.decoderWrite(chunk)\n    }\n\n    callback(null, chunk)\n  }\n\n  decoderWrite (chunk) {\n    // passthrough stream should allow chained streams to continue on error\n    try {\n      this.decoder.write(chunk)\n    } catch (err) {\n      console.warn('[matroska-subtitles] EBML stream decoding error')\n    }\n  }\n}\n"],"names":["SSA_TYPES","Set","SSA_KEYS","getData","chunk","id","el","Children","find","c","data","undefined","SubtitleParserBase","Transform","constructor","subtitleTracks","Map","timecodeScale","_currentClusterTimecode","decoder","EbmlStreamDecoder","bufferTagIds","EbmlTagId","TimecodeScale","Tracks","BlockGroup","AttachedFile","on","parseEbmlSubtitles","bind","Timecode","entry","filter","TrackEntry","TrackType","codecID","CodecID","startsWith","track","number","TrackNumber","language","Language","type","substring","toLowerCase","name","Name","header","CodecPrivate","has","toString","compressed","ContentEncodings","cc","ContentEncoding","ccc","ContentCompression","_compressed","set","emit","Array","from","values","block","Block","blockDuration","BlockDuration","get","payload","inflateSync","Buffer","subtitle","text","time","value","duration","split","i","slice","join","filename","FileName","mimetype","FileMimeType","FileData","SubtitleParser","size","end","_write","_","callback","write","SubtitleStream","prevInstance","once","unstable","_transform","length","len","Math","floor","log2","decoderWrite","err","console","warn"],"mappings":"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"}